trigger:
  branches:
    include:
      - master
  paths:
    exclude:
      - k8s/*

pool:
  vmImage: ubuntu-22.04

variables:
  imageName: molnarimi0211/argopractice
  dockerfilePath: default-deployment/frontend/Dockerfile
  contextPath: default-deployment/frontend
  tag: $(Build.SourceVersion)

stages:
# -----------------------------------
# Stage 1: Build & Push Docker Image
# -----------------------------------
- stage: BuildAndPush
  displayName: Build and Push Docker Image
  jobs:
  - job: Docker
    displayName: Docker Build
    steps:
    - checkout: self

    - script: |
        echo "$(DH_PASSWORD)" | docker login \
          -u "$(DH_USERNAME)" \
          --password-stdin
      displayName: Login to Docker Hub

    - script: |
        docker build \
          -f $(dockerfilePath) \
          -t $(imageName):$(tag) \
          -t $(imageName):latest \
          $(contextPath)

        docker push $(imageName):$(tag)
        docker push $(imageName):latest
      displayName: Build and Push Docker image

# -----------------------------------
# Stage 2: Update Kubernetes Manifests
# -----------------------------------
- stage: UpdateManifests
  displayName: Update Kubernetes manifests
  dependsOn: BuildAndPush
  condition: succeeded()
  jobs:
  - job: GitUpdate
    displayName: Commit new image tag
    steps:
    - checkout: self
      persistCredentials: true

    - script: |
        sed -i "s|__IMAGE_TAG__|$(tag)|g" k8s/4-frontend.yaml
      displayName: Update image tag in manifest

    - script: |
        git config user.name "azure-devops"
        git config user.email "ci@azuredevops"

        git add k8s/4-frontend.yaml

        if git diff --cached --quiet; then
          echo "No manifest changes to commit"
          exit 0
        fi

        git commit -m "chore: update frontend image to $(tag)"
        git push
      displayName: Commit and push changes
